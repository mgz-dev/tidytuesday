---
title: "Tidy Tuesday Freedom Dataset"
author: "M. Zhang"
date: "2022-03-01 (Update 2022-03-09)"
output:
  html_document:
    df_print: tibble
    toc: yes
  pdf_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=FALSE}
library(tidyverse)
library(tidytuesdayR)
library(colorspace)
library(ggforce)
library(ggridges)
library(countrycode)
library(WDI)
library(colorspace)
library(broom)
library(ggrepel)
library(fuzzyjoin)
library(gganimate)

knitr::opts_chunk$set(echo = TRUE, comment = "")
theme_set(theme_bw())
```

# Introduction

We will be working with the `freedom.csv` dataset via the Tidy Tuesday repository. This analysis will not be styled as a "final report", but rather as a quick walk through of some data analysis and wrangling that took place while exploring the data.

The MSDSO Discord group for the University of Texas Masters in Data Science Online program will be doing weekly explorations of TidyTuesday as an exercise for improving their data science skill sets in a collaborative environment.

For this data set, the analysis was first done independently, then augmented by following along with David Robinson's livestream video (https://youtu.be/VOzUHk3aaBw) for additional learning.

## Data Details

This dataset is pulled from the Tidy Tuesday Repository:

Thomas Mock (2022). Tidy Tuesday: A weekly data project aimed at the R ecosystem. https://github.com/rfordatascience/tidytuesday.

The original data is from [Freedom House](https://freedomhouse.org/reports/publication-archives) and the [United Nations](https://unstats.un.org/unsd/methodology/m49/overview/)via [Arthur Cheib](https://github.com/ArthurCheib/analytical-politics-project/blob/main/data/tidy-data-fh-un.csv).

Freedom House is a nonpartisan organization focused on producing research and reports on themes and trends related to democracy, political rights, and civil liberties. This data set `freedom` contains information in regards to various country's Civil Liberty `CL` and Political Rights `PR` index scores, as well as their Least Developed Country `is_ldc` indicator.

## Data Loading

```{r, load-data, message = FALSE, cache = TRUE}
#freedom <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-02-22/freedom.csv')

freedom <- tt_load("2022-02-22")$freedom %>% 
  janitor::clean_names() %>%
  rename(civil_liberties = cl, 
         political_rights = pr) %>%
  mutate(country_code = countrycode(country, origin = "country.name", destination = "iso2c"))

freedom
```


## Data Dictionary

The following tables contain information in regards to the columns available.

`freedom.csv`

|variable    |class     |description |
|:-----------|:---------|:-----------|
|country     |character | Country Name |
|year        |double    | Year |
|CL          |double    | Civil Liberties |
|PR          |double    | Political rights |
|Status      |character | Status (Free `F`, Not Free `NF`, Partially Free `PF`) |
|Region_Code |double    | UN Region code |
|region_name |character | UN Region Name |
|is_ldc      |double    | Is a least developed country (binary 0/1) |

The definition for "Least Developed Country" is pulled from the [United Nations](https://www.un.org/ohrlls/content/ldc-category). A country qualifies for LDC if it meets the criteria for Income, Human Assets, and Economic and Environmental Vulnerability. An important requirement for inclusion is that the country must agree to the classification to be added to the list.

The Civil Liberties and Political Rights score is generated by FreedomHouse, using a methodology inspired by the Universal Declaration of Human Rights which was adopted by the UN General Assembly in 1948, The Civil Liberties score is a combination of 15 separate indicators, and Political Rights score is a combination of 10 separate indicators. Each of these indicators scale from 0 to 4, with 4 representing the greatest amount of freedom. These scores are summarized into indexes for Civil Liberties `civil_liberties` and Political Rights `political_rights` on a scale from 1 to 7, with 1 representing the greatest freedom.

`Status` buckets the combined `CL` and `PR` scores into 3 general categories: Free, Partially Free, and Not Free.

Additional details are available [here](https://freedomhouse.org/reports/freedom-world/freedom-world-research-methodology).

# Data Exploration and wrangling

## Examining the raw data

We will initially take a precursor inspection of the data, utilizing `summary` for numerical information and `table` for categorical information.


```{r cursory-inspection}
glimpse(freedom)
names(freedom)

freedom %>%
  select(civil_liberties, political_rights, is_ldc) %>% 
  summary(freedom)

freedom %>%
  count(country) %>%
  arrange(n)

freedom %>% select(year) %>% table(useNA = "ifany")
freedom %>% select(status) %>% table(useNA = "ifany")
freedom %>% select(region_code) %>% table(useNA = "ifany")
freedom %>% select(region_name) %>% table(useNA = "ifany")
freedom %>% select(is_ldc) %>% table(useNA = "ifany")

freedom %>% 
  distinct(country, region_name) %>% View()
  
```

We can see that it appears that not all countries have full data for all 26 years. There is data ranging from 1995 through 2020, with a total of 193 countries in the data set.

A precursory glance suggest that not all countries have the full year range of data. There are no unexpected unique values from our initial look at the data. Additionally, the `political_rights` and `civil_liberties` (renamed as `polical_rights` and `civil_liberties`) scores are within the expected ranges given the definitions provided by FreedomHouse.

## Checking for NA values

```{r, examine_na}
freedom %>%
  summarize(across(everything(), ~ sum(is.na(.)))) %>%
  tidyr::pivot_longer(everything()) %>%
  arrange(desc(value)) %>% 
  deframe()
```

NA counting methodology was taken from [stackexchange](https://stackoverflow.com/questions/63198917/using-tidyverse-pipeline-to-count-nas-and-reorder)

It appears that there are no NA values in this data set. This is reaffirming our findings from when we checked the summary and tables for the dataset earlier.

## Recoding

Going forward, we will be using the `region_name` column in lieu of `Region_Code` for simplicity. Additionally, we will recode `is_ldc` into categorical values. 

```{r, recode}
freedom = freedom %>% 
  mutate(ldc = if_else(is_ldc == 1, "Yes", "No"),
         freedom_index = political_rights + civil_liberties)

freedom %>%
  select(is_ldc, ldc) %>% unique()
```

## Grouping candidates

Let's examine the total number of unique entries per column to see good candidates for faceting or other categorization methods.

```{r}
freedom %>%
  sapply(n_distinct)
```

We can see that `LDC`, `Status` and `region_name` are all potential ways to cluster data.

## Visual Exploration

Pairwise plot for data - check raw data
```{r, pairplots-1, fig.width = 10, fig.height = 8}
freedom %>%
  select(year, civil_liberties, political_rights, is_ldc, freedom_index) %>%
  pairs()

```

Check grouped data 

```{r, pairplots-2, fig.width = 10, fig.height = 8}
freedom %>%
  group_by(year) %>%
  summarize(mean_civil_liberties = mean(civil_liberties), mean_political_rights = mean(political_rights), mean_ldc = mean(is_ldc), n = n()) %>%
  select(year, mean_civil_liberties, mean_political_rights, mean_ldc, n) %>%
  pairs()

```

```{r}
summarize_freedom <- function(tbl) {
  tbl %>%
    summarize(n_countries = n(), 
              avg_civil_lib = mean(civil_liberties), 
              avg_pol_rights = mean(political_rights),
              pct_free = mean(status == "F"),
              .groups = "drop") %>%
    arrange(desc(n_countries))
}
```


```{r}
by_region <- freedom %>% 
  filter(year == 2020) %>%
  group_by(region_name) %>%
  summarize(n_countries = n(), 
            avg_civil_lib = mean(civil_liberties), 
            avg_pol_rights = mean(political_rights),
            pct_free = mean(status == "F"))

by_region
```


```{r}
by_region %>% ggplot(aes(avg_civil_lib, avg_pol_rights)) + 
  geom_point(aes(size = n_countries)) + 
  geom_abline(color = "red") + 
  geom_text(aes(label = region_name), vjust = 0, hjust = 1.5) + 
  expand_limits(x = 0, y = 0, size = 0)

freedom %>% 
  filter(year == 2020) %>%
  ggplot(aes(civil_liberties, political_rights)) + 
  geom_jitter(height = 0.1, width = 0.1) + 
  geom_abline(color = "red") + 
  expand_limits(x = 0, y = 0, size = 0)
```

## Developing Questions

While examining the data set, the following potential questions arose for investigation:

1. What is the distribution of freedom by Region in a single year?
2. How have the 5 of the best, and 5 of worst non LDC countries shifted in terms of freedom from 1995 to 2020?
3. How are proportions of Free, Partially Free, and Not Free countries shifting over time?
4. How are the distribution of Political Rights, and Civil Liberties fluctuating over time by region?

For the second question, we will need to set criteria for "worst" and "best", and then identify these countries. We will use a combined `political_rights + civil_liberties` score as the gauge of measure. A score of 14 would represent "worst" and 2 would represent "best". We will also exclude countries that do not have data for all years.

```{r, best-worst}
freedom %>%
  filter(year == 1995, ldc == "No") %>%
  select(country, region_name, ldc, freedom_index) %>%
  arrange(freedom_index) %>% head(20)

freedom %>%
  filter(year == 1995, ldc == "No") %>%
  select(country, region_name, ldc, freedom_index) %>%
  arrange(desc(freedom_index)) %>% head(20)

freedom %>%
  filter(year == 1995, ldc == "No", freedom_index == 2) %>%
  arrange(freedom_index) %>% 
  select(country) %>%
  pull()

freedom %>%
  filter(year == 1995, ldc == "No", freedom_index == 14) %>%
  arrange(freedom_index) %>% 
  select(country) %>%
  pull()

exclude_list <- freedom %>%
  group_by(country) %>%
  summarize(n = n()) %>%
  filter(n != 26) %>%
  select(country) %>% pull()
exclude_list
```

A look at the data showed that there was not enough granularity in the scale to determine soley based off the data, thus we chose the following 5 countries based off interest and recent political events.

```{r, best-worst-list}

best_list <- c("Australia", "Canada", "Belgium", "Iceland", "United States of America")
worst_list <- c("China", "Iraq", "Nigeria", "Saudi Arabia", "Viet Nam")
choice_list <-c("Russian Federation", "Ukraine", "Qatar", "Afghanistan", "Rwanda")
best_list
worst_list
```


# Data Visualizations

For the first question, we will look at the most recent year in the data set, 2020, and follow the analysis done by David Robinson:

```{r, fig.height = 10, fig.width = 10}
freedom %>%
  filter(year == 2020) %>%
  gather(key = metric, value = value, civil_liberties, political_rights) %>%
  mutate(metric = str_to_title(str_replace_all(metric, "_", " ")),
         region_name = fct_reorder(region_name, value)) %>%
  count(region_name, metric, value) %>%
  ggplot(aes(value, n)) + 
  geom_col() + 
  facet_grid(region_name ~ metric) + 
  scale_x_continuous(name = "World Freedom Index") + 
  scale_y_continuous(name = "Count of Countries") + 
  ggtitle("Distribution of Freedom Index By Region")
```


## Trends for top and worst 5, and choice

```{r, plot-1, fig.width = 10, fig.height = 8}
freedom %>%
  filter(country %in% best_list) %>%
  pivot_longer(cols = c("political_rights", "civil_liberties"), names_to = "Label", values_to = "Score") %>%
  ggplot() + 
  aes(x = year, y = Score, color = Label) + 
  facet_wrap(
    vars(country),
    ncol = 1) + 
  geom_line(size = 2) + 
  scale_y_continuous(
    limit = c(0, 7)) +
  scale_x_continuous(
    name = "Year") +
  theme_classic()

freedom %>%
  filter(country %in% worst_list) %>%
  pivot_longer(cols = c("political_rights", "civil_liberties"), names_to = "Label", values_to = "Score") %>%
  ggplot() + 
  aes(x = year, y = Score, color = Label) + 
  facet_wrap(
    vars(country),
    ncol = 1) + 
  geom_line(size = 2) +  
  scale_y_continuous(
    limit = c(0, 7)) +
  scale_x_continuous(
    name = "Year") +
  theme_classic()

freedom %>%
  filter(country %in% choice_list) %>%
  pivot_longer(cols = c("political_rights", "civil_liberties"), names_to = "Label", values_to = "Score") %>%
  ggplot() + 
  aes(x = year, y = Score, color = Label) + 
  facet_wrap(
    vars(country),
    ncol = 1) + 
  geom_line(size = 2) + 
  scale_y_continuous(
    limit = c(0, 7)) +
  scale_x_continuous(
    name = "Year") +
  theme_classic()

```

Unfortunately, these plots ended up poor visually. There was also limited movement in the metrics. We could speculate that maybe those with the highest and lowest freedom scores are most "stable" in regards to the operations of their current regime form. A notable exception among those countries scoring "high" in freedom is the U.S., in which this metric shows a decline in freedom starting in 2017.

## Overall trends in freedom over time

```{r, plot-2, fig.width = 10, fig.height = 10}
status_colors = c("#56B4E9", "#D55E00", "#000000")

freedom %>%
  filter(!country %in% exclude_list) %>%
  ggplot() + 
  aes(x = year, fill = factor(status, levels =c("F", "PF", "NF"))) +
  geom_bar(position = "fill") + 
  facet_wrap(
  vars(region_name),
  ncol = 1)  +
  scale_fill_manual(
    name = "",
    values = status_colors,
    breaks = c("F", "PF", "NF"),
    labels = c("Free", "Partially Free", "Not Free")) +
  theme_classic()
```

```{r, plot-2-total, fig.width = 10, fig.height = 4}
freedom %>%
  filter(!country %in% exclude_list) %>%
  ggplot() + 
  aes(x = year, fill = factor(status, levels =c("F", "PF", "NF"))) +
  geom_bar(position = "fill") + 
  scale_fill_manual(
    name = "",
    values = status_colors,
    breaks = c("F", "PF", "NF"),
    labels = c("Free", "Partially Free", "Not Free")) +
  ggtitle("Overall") + 
  theme_classic()

```


## Overall trends in freedom over time by region

```{r, plot-3, fig.width = 10, fig.height = 10}
freedom %>%
  filter(!country %in% exclude_list) %>%
  ggplot() + 
  aes(x = factor(year), y = freedom_index) +
  geom_boxplot() + 
  facet_wrap(
    vars(region_name),
    ncol = 1) + 
  theme_classic()

```

Box plots look quite messy, 

We will re-evaluate with line charts as done in David Robinson's example:

```{r, fig.height = 10, fig.width = 10}
freedom_gathered <- freedom %>%
  gather(key = metric, value = value, civil_liberties, political_rights) %>%
  mutate(metric = str_to_title(str_replace_all(metric, "_", " ")),
         region_name = fct_reorder(region_name, value))

overall <- freedom_gathered %>%
  group_by(year, metric) %>%
  summarize(avg_rating = mean(value))

freedom_gathered %>%
  # mutate(region_name = "Overall") %>%
  # bind_rows(freedom_gathered) %>%
  group_by(year, region_name, metric) %>%
  summarize(avg_rating = mean(value)) %>%
  ggplot(aes(year, avg_rating)) + 
  geom_line(size = 1, aes(color = region_name)) + 
  geom_line(data = overall, size = 2) + 
  facet_wrap(~ metric) + 
  expand_limits(y = 1) + 
  scale_x_continuous(name = "Year") + 
  scale_y_reverse(name = "World Freedom Index", breaks = seq(1,7)) + 
  scale_color_discrete(name = "Region", guide = guide_legend(reverse = TRUE)) + 
  ggtitle("Change of Freedom Index over time by Region", subtitle = "Black Shows Overall")
```

# Additional Analysis joined with other data sets

We will perform some additional analysis by pulling in other data sets.

## Worldbank Data

More information available at [The World Bank](https://databank.worldbank.org/home).

```{r, wdi}
#WDIsearch("gdp") %>% View()

gdp_percap <- WDI(indicator = "NY.GDP.PCAP.CD",
                  extra = TRUE, 
                  start = 1995,
                  end = 2020) %>%
  as_tibble()

# gdp_percap %>% View()

# freedom %>% distinct(country) %>% anti_join(gdp_percap, by = "country") %>% View()

# gdp_percap %>% filter(str_detect(country, "Egypt"))

```

```{r, wdi-join}
freedom_join <- freedom %>% 
  inner_join(gdp_percap, 
             by = c(country_code = "iso2c", "year"), 
             suffix = c("", "_wdi")) %>%
  mutate(income = fct_relevel(income, c("Low income", "Lower middle income", "Upper middle income")))

freedom_join %>%
  filter(year == 2020, income != "Not classified") %>%
  group_by(income) %>%
  summarize_freedom() %>%
  arrange(income)


freedom_join_gathered <- freedom_join %>%
  filter(income != "Not classified") %>%
  gather(key = metric, value = value, civil_liberties, political_rights) %>%
  mutate(metric = str_to_title(str_replace_all(metric, "_", " ")))

overall_join <- freedom_join_gathered %>%
  group_by(year, metric) %>%
  summarize(avg_rating = mean(value))

freedom_join_gathered %>%
  # mutate(region_name = "Overall") %>%
  # bind_rows(freedom_gathered) %>%
  group_by(year, income, metric) %>%
  summarize(avg_rating = mean(value)) %>%
  ggplot(aes(year, avg_rating)) + 
  geom_line(size = 1, aes(color = income)) + 
  geom_line(data = overall_join, size = 2) + 
  facet_wrap(~ metric) + 
  expand_limits(y = 1) + 
  scale_x_continuous(name = "Year") + 
  scale_y_reverse(name = "World Freedom Index", breaks = seq(1,7)) + 
  scale_color_discrete(name = "World Bank Income", guide = guide_legend(reverse = TRUE)) + 
  ggtitle("Change of Freedom Index over time by Income", subtitle = "Black Shows Overall")
```

How do we find the biggest outliers?

```{r, outliers}
civil_liberties_2020 <- freedom_join_gathered %>%
    filter(!is.na(NY.GDP.PCAP.CD),
           metric == "Civil Liberties",
         year == 2020)

lin_mod <- civil_liberties_2020 %>% 
  lm(value ~ region_name + log10(NY.GDP.PCAP.CD), data = .) 

lin_mod %>% 
  augment(data = civil_liberties_2020) %>%
  select(country, region_name, NY.GDP.PCAP.CD, income, value, .fitted, .resid) %>% 
  arrange(desc(abs(.resid))) %>% 
  head(20) %>%
  ggplot(aes(.fitted, value)) + 
  geom_point() + 
  geom_abline(color = "red") + 
  geom_text_repel(aes(label = country)) + 
  scale_x_reverse(name = "Model Civil Liberty") + 
  scale_y_reverse(name = "Actual Civil Liberty") + 
  expand_limits(x = 1, y = 1) + 
  ggtitle("Outliers for Civil Liberties", subtitle = "Lower Number is Better")
  
```

Map Visual 

```{r, static-map}
freedom_2020 <- freedom_join_gathered %>%
  filter(year == 2020,
         metric == "Civil Liberties")

# maps::iso3166

world_map_freedom_2020 <- map_data("world") %>%
  as_tibble() %>%
  regex_left_join(maps::iso3166, c(region = "mapname")) %>%
  left_join(freedom_2020 %>% select(-region), by = c(a2 = "country_code")) %>%
  filter(region != "Antarctica")

world_map_freedom_2020 %>%
  ggplot(aes(long, lat, group = group)) + 
  geom_polygon(aes(fill = value)) + 
  coord_fixed(1.5) + 
  scale_fill_continuous_diverging(palette = "Blue-Red", mid = 3.5, name = "Freedom Index: Civil Liberties") + 
  ggtitle("Civil Liberties Index", subtitle = "In 2020") + 
  ggthemes::theme_map()

```

Animated Map 

```{r, animated-map, cache = TRUE}
world_map_freedom <- map_data("world") %>%
  as_tibble() %>%
  regex_left_join(maps::iso3166, c(region = "mapname")) %>%
  left_join(freedom_join_gathered %>% select(-region), by = c(a2 = "country_code")) %>%
  filter(region != "Antarctica")

freedom_animate <- world_map_freedom %>%
  filter(metric == "Civil Liberties") %>%
  ggplot(aes(long, lat, group = group)) + 
  geom_polygon(aes(fill = value)) + 
  coord_map(xlim = c(-180, 180)) + 
  scale_fill_continuous_diverging(palette = "Blue-Red-2", mid = 3.5, name = "Freedom Index: Civil Liberties") + 
  ggtitle("World Freedom Index: Civil Liberties ({ current_frame})", subtitle = "Lower is more Free") + 
  ggthemes::theme_map(14) + 
  transition_manual(year)
animate(freedom_animate, height = 800, width =1000)
anim_save("world_civil_liberties.gif")
```

# Conclusion

This data set was fairly clean and had a large amount of pre-processing completed on it. My impression is that it would have been better for Country-level analysis if the data set had supplied the raw indicator scores which composed the civil_liberties and political_rights metrics. As can be seen in the "Top 5" and "Worst 5" bar charts, the level of granularity provided gives minimal year by year changes. Region level analysis has more apparent trends when examining both by region and changes over time. Lastly, by bringing in economic indicators, we can examine the correlation between freedom and income.
